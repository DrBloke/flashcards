---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection, type CollectionKey } from "astro:content";
import { deckSchema, type Deck } from "../schemas/deck";
import { setsSchema, type SetInfo } from "../schemas/sets";
import rawSets from "../sets.json";

export async function getStaticPaths() {
  const sets = setsSchema.parse(rawSets);
  return sets.map((set) => ({
    params: { set: set.path },
    props: { set },
  }));
}

type Props = { set: SetInfo };
const { set } = Astro.props;
const entries = await getCollection(set.path as CollectionKey);
const decks = entries.map((entry) => ({
  id: entry.id,
  data: deckSchema.parse(entry.data) as Deck,
}));

const title = set.title;
---

<BaseLayout pageTitle={title}>
  <main data-set-path={set.path}>
    <h1>{title}</h1>

    <wa-details summary="Settings">
      <div class="settings-row">
        <wa-switch id="reverse-deck-switch">Reverse Decks</wa-switch>
        <wa-switch id="shuffle-deck-switch">Shuffle</wa-switch>
      </div>
      <wa-details summary="Review Schedule">
        <schedule-editor set-path={set.path}></schedule-editor>
      </wa-details>
    </wa-details>
    <div class="deck-list-container">
      <deck-list
        decks={JSON.stringify(
          decks.map((d) => ({
            id: d.id,
            title: d.data.title,
            totalCards: d.data.cards.length,
          })),
        )}
        set-path={set.path}
        base-url={import.meta.env.BASE_URL}
      >
      </deck-list>
    </div>
  </main>
</BaseLayout>

<style>
  main {
    margin: var(--wa-space-l);
  }
  .settings-row {
    display: flex;
    flex-wrap: wrap;
    gap: var(--wa-space-l);
    margin-bottom: var(--wa-space-l);
    padding: var(--wa-space-s) 0;
  }
  wa-details {
    margin-top: var(--wa-space-s);
  }
</style>

<script>
  import "@awesome.me/webawesome/dist/components/switch/switch.js";
  import "@awesome.me/webawesome/dist/components/details/details.js";
  import "../components/lit/DeckList.ts";
  import "../components/lit/ScheduleEditor.ts";
  import { flashcardsStorageSchema } from "../schemas/storage";

  await customElements.whenDefined("wa-switch");

  const main = document.querySelector("main");
  const setPath = main?.getAttribute("data-set-path");

  function syncSwitches() {
    if (!setPath) return;
    const rawData = localStorage.getItem("flashcards-data");
    const parsed = rawData ? JSON.parse(rawData) : {};
    const result = flashcardsStorageSchema.safeParse(parsed);
    const allData = result.success ? result.data : {};

    const setData = allData[setPath];
    const isReversed = setData?.settings?.reverseDeck === true;
    const isShuffled = setData?.settings?.shuffleDeck === true;

    const reverseDeckSwitch = document.getElementById("reverse-deck-switch");
    const shuffleDeckSwitch = document.getElementById("shuffle-deck-switch");

    if (reverseDeckSwitch) {
      (reverseDeckSwitch as HTMLElement & { checked: boolean }).checked =
        isReversed;
    }
    if (shuffleDeckSwitch) {
      (shuffleDeckSwitch as HTMLElement & { checked: boolean }).checked =
        isShuffled;
    }
  }

  // Initial sync
  syncSwitches();

  // Listen for external changes or schedule resets that might affect defaults
  window.addEventListener("flashcards-data-changed", syncSwitches);

  const reverseDeckSwitch = document.getElementById("reverse-deck-switch");
  const shuffleDeckSwitch = document.getElementById("shuffle-deck-switch");

  if (reverseDeckSwitch && setPath) {
    reverseDeckSwitch.addEventListener("change", (event: Event) => {
      const target = event.target as HTMLElement & { checked: boolean };
      if (target) {
        const rawData = localStorage.getItem("flashcards-data");
        const parsed = rawData ? JSON.parse(rawData) : {};
        const result = flashcardsStorageSchema.safeParse(parsed);
        const currentData = result.success ? result.data : {};

        if (!currentData[setPath]) currentData[setPath] = { settings: {} };
        if (!currentData[setPath].settings) currentData[setPath].settings = {};
        currentData[setPath].settings.reverseDeck = target.checked;
        localStorage.setItem("flashcards-data", JSON.stringify(currentData));
        window.dispatchEvent(new CustomEvent("flashcards-data-changed"));
      }
    });
  }

  if (shuffleDeckSwitch && setPath) {
    shuffleDeckSwitch.addEventListener("change", (event: Event) => {
      const target = event.target as HTMLElement & { checked: boolean };
      if (target) {
        const rawData = localStorage.getItem("flashcards-data");
        const parsed = rawData ? JSON.parse(rawData) : {};
        const result = flashcardsStorageSchema.safeParse(parsed);
        const currentData = result.success ? result.data : {};

        if (!currentData[setPath]) currentData[setPath] = { settings: {} };
        if (!currentData[setPath].settings) currentData[setPath].settings = {};
        currentData[setPath].settings.shuffleDeck = target.checked;
        localStorage.setItem("flashcards-data", JSON.stringify(currentData));
        window.dispatchEvent(new CustomEvent("flashcards-data-changed"));
      }
    });
  }
</script>
