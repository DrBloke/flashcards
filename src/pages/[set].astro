---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection, type CollectionKey } from "astro:content";
import { deckSchema, type Deck } from "../schemas/deck";
import { setsSchema, type SetInfo } from "../schemas/sets";
import rawSets from "../sets.json";

export async function getStaticPaths() {
  const sets = setsSchema.parse(rawSets);
  return sets.map((set) => ({
    params: { set: set.path },
    props: { set },
  }));
}

type Props = { set: SetInfo };
const { set } = Astro.props;
const entries = await getCollection(set.path as CollectionKey);
const decks = entries.map((entry) => ({
  id: entry.id,
  data: deckSchema.parse(entry.data) as Deck,
}));

const title = set.title;
---

<BaseLayout pageTitle={title}>
  <main>
    <h1>{title}</h1>
    <wa-switch id="reverse-deck-switch">Reverse Decks</wa-switch>
    <wa-switch id="shuffle-deck-switch">Shuffle</wa-switch>
    <p><a href={import.meta.env.BASE_URL}>Back to Home</a></p>
    <ul>
      {
        decks.map((deck) => (
          <li>
            <a href={import.meta.env.BASE_URL + set.path + "/" + deck.id}>
              {deck.data.title}
            </a>
          </li>
        ))
      }
    </ul>
  </main>
</BaseLayout>

<script>
  import "@awesome.me/webawesome/dist/components/switch/switch.js";

  await customElements.whenDefined("wa-switch");

  const reverseDeckSwitch = document.getElementById("reverse-deck-switch");
  const shuffleDeckSwitch = document.getElementById("shuffle-deck-switch");

  // Load state from localStorage
  const isReversed = localStorage.getItem("reverseDeck") === "true";
  const isShuffled = localStorage.getItem("shuffleDeck") === "true";

  if (reverseDeckSwitch) {
    (reverseDeckSwitch as HTMLElement & { checked: boolean }).checked =
      isReversed;

    reverseDeckSwitch.addEventListener("change", (event) => {
      const target = event.target as HTMLElement & { checked: boolean };
      if (target) {
        localStorage.setItem("reverseDeck", String(target.checked));
      }
    });
  }

  if (shuffleDeckSwitch) {
    (shuffleDeckSwitch as HTMLElement & { checked: boolean }).checked =
      isShuffled;

    shuffleDeckSwitch.addEventListener("change", (event) => {
      const target = event.target as HTMLElement & { checked: boolean };
      if (target) {
        localStorage.setItem("shuffleDeck", String(target.checked));
      }
    });
  }
</script>
