---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection, type CollectionKey } from "astro:content";
import { deckSchema, type Deck } from "../schemas/deck";
import { setsSchema, type SetInfo } from "../schemas/sets";
import rawSets from "../sets.json";

export async function getStaticPaths() {
  const sets = setsSchema.parse(rawSets);
  return sets.map((set) => ({
    params: { set: set.path },
    props: { set },
  }));
}

type Props = { set: SetInfo };
const { set } = Astro.props;
const entries = await getCollection(set.path as CollectionKey);
const decks = entries.map((entry) => ({
  id: entry.id,
  data: deckSchema.parse(entry.data) as Deck,
}));

const title = set.title;
---

<BaseLayout pageTitle={title}>
  <main data-set-path={set.path}>
    <h1>{title}</h1>
    <wa-switch id="reverse-deck-switch">Reverse Decks</wa-switch>
    <wa-switch id="shuffle-deck-switch">Shuffle</wa-switch>
    <p><a href={import.meta.env.BASE_URL}>Back to Home</a></p>
    <ul>
      {
        decks.map((deck) => (
          <li>
            <a href={import.meta.env.BASE_URL + set.path + "/" + deck.id}>
              {deck.data.title}
            </a>
          </li>
        ))
      }
    </ul>
  </main>
</BaseLayout>

<script>
  import "@awesome.me/webawesome/dist/components/switch/switch.js";
  import { flashcardsStorageSchema } from "../schemas/storage";

  await customElements.whenDefined("wa-switch");

  const main = document.querySelector("main");
  const setPath = main?.getAttribute("data-set-path");

  // Load state from localStorage
  const rawData = localStorage.getItem("flashcards-data");
  const parsed = rawData ? JSON.parse(rawData) : {};
  const result = flashcardsStorageSchema.safeParse(parsed);
  const allData = result.success ? result.data : {};

  const setData = setPath ? allData[setPath] : null;
  const isReversed = setData?.settings?.reverseDeck === true;
  const isShuffled = setData?.settings?.shuffleDeck === true;

  const reverseDeckSwitch = document.getElementById("reverse-deck-switch");
  const shuffleDeckSwitch = document.getElementById("shuffle-deck-switch");

  if (reverseDeckSwitch && setPath) {
    (reverseDeckSwitch as HTMLElement & { checked: boolean }).checked =
      isReversed;

    reverseDeckSwitch.addEventListener("change", (event: Event) => {
      const target = event.target as HTMLElement & { checked: boolean };
      if (target) {
        const rawData = localStorage.getItem("flashcards-data");
        const parsed = rawData ? JSON.parse(rawData) : {};
        const result = flashcardsStorageSchema.safeParse(parsed);
        const currentData = result.success ? result.data : {};

        if (!currentData[setPath]) currentData[setPath] = { settings: {} };
        if (!currentData[setPath].settings) currentData[setPath].settings = {};
        currentData[setPath].settings.reverseDeck = target.checked;
        localStorage.setItem("flashcards-data", JSON.stringify(currentData));
      }
    });
  }

  if (shuffleDeckSwitch && setPath) {
    (shuffleDeckSwitch as HTMLElement & { checked: boolean }).checked =
      isShuffled;

    shuffleDeckSwitch.addEventListener("change", (event: Event) => {
      const target = event.target as HTMLElement & { checked: boolean };
      if (target) {
        const rawData = localStorage.getItem("flashcards-data");
        const parsed = rawData ? JSON.parse(rawData) : {};
        const result = flashcardsStorageSchema.safeParse(parsed);
        const currentData = result.success ? result.data : {};

        if (!currentData[setPath]) currentData[setPath] = { settings: {} };
        if (!currentData[setPath].settings) currentData[setPath].settings = {};
        currentData[setPath].settings.shuffleDeck = target.checked;
        localStorage.setItem("flashcards-data", JSON.stringify(currentData));
      }
    });
  }
</script>
